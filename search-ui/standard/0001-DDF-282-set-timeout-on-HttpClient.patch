From 4f69beaaa6a86ada16043ec2dbd08895d95196e4 Mon Sep 17 00:00:00 2001
From: Jason Smith <jason.lc.smith@lmco.com>
Date: Wed, 22 Jan 2014 14:55:42 -0700
Subject: [PATCH] DDF-282 - set timeout on HttpClient

---
 .../codice/ddf/ui/searchui/proxy/ProxyServlet.java | 24 ++++++++++++++++------
 .../standard/properties/ConfigurationStore.java    | 13 ++++++++++++
 .../main/resources/OSGI-INF/metatype/metatype.xml  |  4 +++-
 3 files changed, 34 insertions(+), 7 deletions(-)

diff --git a/search-ui/standard/src/main/java/org/codice/ddf/ui/searchui/proxy/ProxyServlet.java b/search-ui/standard/src/main/java/org/codice/ddf/ui/searchui/proxy/ProxyServlet.java
index bdbcc71..a5c96ca 100644
--- a/search-ui/standard/src/main/java/org/codice/ddf/ui/searchui/proxy/ProxyServlet.java
+++ b/search-ui/standard/src/main/java/org/codice/ddf/ui/searchui/proxy/ProxyServlet.java
@@ -62,6 +62,7 @@ import org.apache.http.message.BasicHttpEntityEnclosingRequest;
 import org.apache.http.message.BasicHttpRequest;
 import org.apache.http.message.HeaderGroup;
 import org.apache.http.params.BasicHttpParams;
+import org.apache.http.params.HttpConnectionParams;
 import org.apache.http.params.HttpParams;
 import org.apache.http.util.EntityUtils;
 import org.codice.ddf.ui.searchui.standard.properties.ConfigurationStore;
@@ -112,6 +113,8 @@ public class ProxyServlet extends HttpServlet {
 
     protected HttpClient proxyClient;
     
+    protected int timeout = 5000;
+    
     @Override
     public String getServletInfo() {
         return "A proxy servlet by David Smiley, dsmiley@mitre.org";
@@ -126,10 +129,14 @@ public class ProxyServlet extends HttpServlet {
             this.doForwardIP = Boolean.parseBoolean(doForwardIPString);
         }
 
-        HttpParams hcParams = new BasicHttpParams();
+        final HttpParams hcParams = new BasicHttpParams();
+        timeout = ConfigurationStore.getInstance().getTimeout();
+        HttpConnectionParams.setSoTimeout(hcParams, timeout);
+        HttpConnectionParams.setConnectionTimeout(hcParams, timeout);
         readConfigParam(hcParams, ClientPNames.HANDLE_REDIRECTS, Boolean.class);
+
         proxyClient = createHttpClient(hcParams);
-    }
+    }  
 
     /**
      * Called from {@link #init(javax.servlet.ServletConfig)}. HttpClient offers many opportunities
@@ -224,10 +231,15 @@ public class ProxyServlet extends HttpServlet {
 
         try {
             // Execute the request
-            logger.debug("proxy {} uri: {} -- {}",  method, servletRequest.getRequestURI(), proxyRequest.getRequestLine().getUri());
-
-            HttpResponse proxyResponse = proxyClient.execute(URIUtils.extractHost(getTargetUriObj()),
-                    proxyRequest);
+            HttpResponse proxyResponse;
+            logger.debug("proxy {} uri: {} -- {}, timeout: {}", method,
+                    servletRequest.getRequestURI(), proxyRequest.getRequestLine().getUri(),
+                    timeout);
+
+            synchronized (this) {
+                proxyResponse = proxyClient.execute(URIUtils.extractHost(getTargetUriObj()),
+                        proxyRequest);
+            }
 
             // Process the response
             int statusCode = proxyResponse.getStatusLine().getStatusCode();
diff --git a/search-ui/standard/src/main/java/org/codice/ddf/ui/searchui/standard/properties/ConfigurationStore.java b/search-ui/standard/src/main/java/org/codice/ddf/ui/searchui/standard/properties/ConfigurationStore.java
index 97998a0..cd7b199 100644
--- a/search-ui/standard/src/main/java/org/codice/ddf/ui/searchui/standard/properties/ConfigurationStore.java
+++ b/search-ui/standard/src/main/java/org/codice/ddf/ui/searchui/standard/properties/ConfigurationStore.java
@@ -65,6 +65,8 @@ public class ConfigurationStore {
     private static String JSON_MIME_TYPE_STRING = "application/json";
 
     private static MimeType JSON_MIME_TYPE = null;
+    
+    private Integer timeout = 5000;
 
     static {
         MimeType mime = null;
@@ -84,6 +86,7 @@ public class ConfigurationStore {
         wmsServer = "";
         layers = "";
         format = "";
+        timeout = 5000;
     }
 
     @GET
@@ -99,6 +102,8 @@ public class ConfigurationStore {
         configObj.put("wmsServer", wmsServer);
         configObj.put("layers", layers);
         configObj.put("format", format);
+        configObj.put("timeout", timeout);
+
 
         String configString = JSONValue.toJSONString(configObj);
         BinaryContent content = new BinaryContentImpl(new ByteArrayInputStream(configString.getBytes()),
@@ -190,6 +195,14 @@ public class ConfigurationStore {
     public void setFormat(String format) {
         this.format = format;
     }
+    
+    public Integer getTimeout() {
+        return timeout;
+    }
+
+    public void setTimeout(Integer timeout) {
+        this.timeout = timeout;
+    }
 
     public Object clone() throws CloneNotSupportedException {
         throw new CloneNotSupportedException();
diff --git a/search-ui/standard/src/main/resources/OSGI-INF/metatype/metatype.xml b/search-ui/standard/src/main/resources/OSGI-INF/metatype/metatype.xml
index 07ec5a6..a5c531a 100644
--- a/search-ui/standard/src/main/resources/OSGI-INF/metatype/metatype.xml
+++ b/search-ui/standard/src/main/resources/OSGI-INF/metatype/metatype.xml
@@ -71,7 +71,9 @@
             name="WMS Format" id="format" required="false" type="String"
             default=""
         />
-	</OCD>
+        <AD description="Specifies the connection timeout to use when connecting to WMS services." name="Connection Timeout" id="timeout"
+            required="false" type="Integer" default="5000" />
+	    </OCD>
 
 	<Designate 	pid="org.codice.ddf.ui.search.standard.properties">
 		<Object ocdref="org.codice.ddf.ui.search.standard.properties" />
-- 
1.8.3.4 (Apple Git-47)

