<?xml version="1.0" encoding="UTF-8"?>
<!-- /**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either
 * version 3 of the License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public License is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/ -->
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xsi:schemaLocation="
	    http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
        ">

    <reference id="eventAdmin" interface="org.osgi.service.event.EventAdmin"/>

    <reference-list id="resourceActionProviderList" interface="ddf.action.ActionProvider"
                    filter="(id=catalog.data.metacard.resource)" availability="optional"/>

    <bean id="retrieveStatusEventPublisher"
          class="ddf.catalog.event.retrievestatus.DownloadsStatusEventPublisher">
        <argument ref="eventAdmin"/>
        <argument ref="resourceActionProviderList"/>
        <property name="notificationEnabled" value="true"/>
    </bean>
    <!--
        <service ref="retrieveStatusEventPublisher"
                 interface="ddf.catalog.event.retrievestatus.DownloadsStatusEventPublisher"/> -->

    <bean id="retrieveStatusEventListener"
          class="ddf.catalog.event.retrievestatus.DownloadsStatusEventListenerImpl"/>
    <service ref="retrieveStatusEventListener"
             interface="ddf.catalog.event.retrievestatus.DownloadsStatusEventListener">
        <service-properties>
            <entry key="event.topics">
                <array value-type="java.lang.String">
                    <value>ddf/download/cancel</value>
                </array>
            </entry>
        </service-properties>
    </service>

    <bean id="downloadStatusInfo" class="ddf.catalog.event.retrievestatus.DownloadStatusInfoImpl">
        <property name="eventAdmin" ref="eventAdmin"/>
    </bean>
    <service ref="downloadStatusInfo"
             interface="ddf.catalog.event.retrievestatus.DownloadStatusInfo"/>

    <bean id="resourceCache" class="ddf.catalog.cache.impl.ResourceCacheImpl"
          init-method="setupCache"
          destroy-method="teardownCache">
        <property name="resourceCacheDirectory" value=""/>
        <property name="cacheDirMaxSizeMegabytes" value="10240"/>
        <!-- 10 GB -->
        <property name="context" ref="blueprintBundleContext"/>
        <property name="xmlConfigFilename" value="reliableResource-hazelcast.xml"/>
    </bean>

    <service ref="resourceCache" interface="ddf.catalog.cache.ResourceCache"/>

    <bean id="downloadManager"
          class="ddf.catalog.resource.downloadmanager.ReliableResourceDownloadManagerImpl">
        <cm:managed-properties
                persistent-id="ddf.catalog.core.cache"
                update-strategy="container-managed"/>
        <argument ref="resourceCache"/>
        <argument ref="retrieveStatusEventPublisher"/>
        <argument ref="retrieveStatusEventListener"/>
        <argument ref="downloadStatusInfo"/>
        <property name="delayBetweenRetryAttempts" value="10"/>
        <property name="maxRetryAttempts" value="3"/>
        <property name="retrievalMonitorPeriod" value="5"/>
        <property name="cacheEnabled" value="false"/>
        <property name="cacheWhenCanceled" value="false"/>
        <property name="notificationEnabled" value="true"/>
        <property name="resourceCacheDirectory" value=""/>

    </bean>

    <service ref="downloadManager"
             interface="ddf.catalog.resource.download.ReliableResourceDownloadManager"/>

</blueprint>